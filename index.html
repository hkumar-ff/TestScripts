<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Suite Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .suite { border: 1px solid #ccc; padding: 10px; margin: 10px 0; cursor: pointer; }
        .suite:hover { background-color: #f0f0f0; }
        .test-case { border: 1px solid #ddd; padding: 5px; margin: 5px 0; }
        .play-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .result { margin-left: 10px; font-weight: bold; }
        .pass { color: green; }
        .fail { color: red; }
        .form { margin: 10px 0; }
        input, button { margin: 5px; padding: 5px; }
        .history-btn { background-color: #2196F3; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-left: 5px; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; }
        .execution-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; cursor: pointer; }
        .execution-item:hover { background-color: #f9f9f9; }
        .execution-details { margin-top: 20px; padding: 10px; background-color: #f5f5f5; }
        .screenshot-gallery img { margin: 5px; border: 1px solid #ccc; cursor: pointer; }
        .viewer-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .viewer-content { position: relative; width: 50vw; height: calc(50vw * 9 / 16); margin: auto; top: 50%; transform: translateY(-50%); background-color: #000; border-radius: 8px; overflow: hidden; }
        .viewer-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .viewer-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255,255,255,0.3); color: white; border: none; font-size: 24px; padding: 10px; cursor: pointer; user-select: none; }
        .viewer-prev { left: 10px; }
        .viewer-next { right: 10px; }
        .viewer-close { position: absolute; top: 10px; right: 10px; background-color: rgba(255,255,255,0.3); color: white; border: none; font-size: 20px; padding: 5px 10px; cursor: pointer; }
        .viewer-counter { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white; background-color: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Test Suite Dashboard</h1>
    <div class="form">
        <input type="text" id="suiteName" placeholder="New Suite Name">
        <button onclick="createSuite()">Create Suite</button>
    </div>
    <div id="suites"></div>

    <div id="suiteView" style="display: none;">
        <button onclick="backToSuites()">Back to Suites</button>
        <h2 id="suiteTitle"></h2>
        <div>
            <label for="targetUrl">Target URL:</label>
            <input type="text" id="targetUrl" value="https://dev.controlcase.com">
        </div>
        <div class="form">
            <input type="text" id="caseName" placeholder="Script Name (e.g., test.js)">
            <input type="text" id="caseDesc" placeholder="Description">
            <button onclick="addTestCase()">Add Test Case</button>
        </div>
        <div id="testCases"></div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2 id="historyTitle">Test Case History</h2>
            <div id="executionList"></div>
            <div id="executionDetails" style="display: none;"></div>
        </div>
    </div>

    <!-- Screenshot Viewer Modal -->
    <div id="screenshotViewerModal" class="viewer-modal">
        <div class="viewer-content">
            <button class="viewer-close" onclick="closeScreenshotViewer()">&times;</button>
            <button class="viewer-nav viewer-prev" onclick="navigateScreenshot(-1)">&#10094;</button>
            <button class="viewer-nav viewer-next" onclick="navigateScreenshot(1)">&#10095;</button>
            <img id="viewerImage" class="viewer-image" src="" alt="Screenshot">
            <div id="viewerCounter" class="viewer-counter"></div>
        </div>
    </div>

    <script>
        let currentSuiteId = null;

        function loadSuites() {
            $.get('/suites', function(data) {
                $('#suites').empty();
                data.forEach(suite => {
                    $('#suites').append(`<div class="suite" onclick="viewSuite('${suite.id}', '${suite.name}')">${suite.name}</div>`);
                });
            });
        }

        function createSuite() {
            const name = $('#suiteName').val();
            if (!name) return;
            $.post('/suites', JSON.stringify({name}), function() {
                loadSuites();
                $('#suiteName').val('');
            });
        }

        function viewSuite(id, name) {
            currentSuiteId = id;
            $('#suiteTitle').text(name);
            $('#suites').hide();
            $('#suiteView').show();
            $.get(`/suites/${id}`, function(suite) {
                $('#testCases').empty();
                suite.testCases.forEach(tc => {
                const inputDataJson = JSON.stringify(tc.inputData || {}, null, 2);
                $('#testCases').append(`<div class="test-case">
                        <strong>${tc.name}</strong> - ${tc.description}
                        <button class="play-btn" onclick="runTest('${tc.id}', this)">‚ñ∂ Run</button>
                        <button class="history-btn" onclick="showHistory('${tc.id}', '${tc.name}')">üìä History</button>
                        <span class="result"></span>
                        <div class="input-section" style="margin-top: 10px;">
                            <button onclick="toggleInputSection(this)" style="background: #f0f0f0; border: 1px solid #ccc; padding: 2px 5px; cursor: pointer;">üìù Input Data</button>
                            <div class="input-data" style="display: none; margin-top: 5px;">
                                <textarea id="input-${tc.id}" placeholder='Enter JSON input data (e.g., {"username": "test", "password": "pass123"})' rows="4" cols="60" style="font-family: monospace;">${inputDataJson}</textarea>
                                <div style="margin-top: 5px;">
                                    <button onclick="validateJson('${tc.id}')" style="background: #2196F3; color: white; border: none; padding: 3px 8px; cursor: pointer;">Validate JSON</button>
                                    <span id="json-status-${tc.id}" style="margin-left: 10px;"></span>
                                </div>
                            </div>
                        </div>
                        <div class="screenshots" style="margin-top: 10px;"></div>
                    </div>`);
                });
            });
        }

        function backToSuites() {
            $('#suiteView').hide();
            $('#suites').show();
        }

        function addTestCase() {
            const name = $('#caseName').val();
            const desc = $('#caseDesc').val();
            if (!name || !desc) return;
            $.ajax({
                method: 'POST',
                url: `/suites/${currentSuiteId}/cases`,
                contentType: 'application/json',
                data: JSON.stringify({name, description: desc}),
                success: function() {
                    viewSuite(currentSuiteId, $('#suiteTitle').text());
                    $('#caseName').val('');
                    $('#caseDesc').val('');
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    alert(response.error || 'Failed to add test case');
                }
            });
        }

        function runTest(caseId, btn) {
            const url = $('#targetUrl').val().trim();
            if (!url) {
                alert('Target URL is a must to proceed.');
                return;
            }

            // Get JSON input data
            const inputTextarea = $(`#input-${caseId}`);
            let inputData = {};
            if (inputTextarea.length && inputTextarea.val().trim()) {
                try {
                    inputData = JSON.parse(inputTextarea.val().trim());
                } catch (e) {
                    alert('Invalid JSON in input data: ' + e.message);
                    return;
                }
            }

            $(btn).prop('disabled', true).text('Running...');
            $.ajax({
                method: 'POST',
                url: `/suites/${currentSuiteId}/cases/${caseId}/run`,
                contentType: 'application/json',
                data: JSON.stringify({url, inputData}),
                success: function(data) {
                    const resultEl = $(btn).siblings('.result');
                    resultEl.removeClass('pass fail');
                    if (data.result === 'PASS') {
                        resultEl.addClass('pass').text('PASS');
                    } else if (data.result === 'FAIL') {
                        resultEl.addClass('fail').text('FAIL');
                    } else if (data.result === 'ERROR') {
                        resultEl.addClass('fail').text(`ERROR: ${data.message || 'Unknown error'}`);
                    } else if (data.result === 'TIMEOUT') {
                        resultEl.addClass('fail').text(`TIMEOUT: ${data.message || 'Script timed out'}`);
                    } else {
                        resultEl.addClass('fail').text(`${data.result}: ${data.message || ''}`);
                    }
                    $(btn).prop('disabled', false).text('‚ñ∂ Run');
                    if (data.screenshots && data.screenshots.length) {
                        const screenshotHtml = 'Screenshots: ' + data.screenshots.map(s => `<a href="${s}" target="_blank"><img src="${s}" alt="Step screenshot" width="100" height="60"></a>`).join(' ');
                        $(btn).siblings('.screenshots').html(screenshotHtml);
                    } else {
                        $(btn).siblings('.screenshots').html('');
                    }
                    if (data.logs) {
                        const logsLink = `<br><a href="${data.logs}" download target="_blank">Download Logs</a>`;
                        $(btn).siblings('.screenshots').append(logsLink);
                    }
                }
            });
        }

        function showHistory(caseId, caseName) {
            $('#historyTitle').text(`History for ${caseName}`);
            $('#executionList').html('<p>Loading...</p>');
            $('#executionDetails').hide();

            $.get(`/suites/${currentSuiteId}/cases/${caseId}/history`, function(data) {
                if (data.length === 0) {
                    $('#executionList').html('<p>No execution history found.</p>');
                    return;
                }

                // Store execution data in element data for later use
                $('#executionList').data('executions', data);

                const listHtml = data.map(execution => {
                    const resultClass = execution.result === 'PASS' ? 'pass' : execution.result === 'FAIL' ? 'fail' : 'fail';
                    const timestamp = new Date(execution.timestamp).toLocaleString();
                    return `<div class="execution-item" onclick="showExecutionDetails('${execution.id}')">
                        <strong>${execution.result}</strong> - ${timestamp}
                        <div>URL: ${execution.url}</div>
                        ${execution.message ? `<div>Message: ${execution.message}</div>` : ''}
                        <div>Screenshots: ${execution.screenshots.length}, Logs: Available</div>
                    </div>`;
                }).join('');

                $('#executionList').html(listHtml);
                $('#historyModal').show();
            });
        }

        function showExecutionDetails(executionId) {
            // Find the execution data in the list (we'll store it in the element data)
            const executionData = $('#executionList').data('executions').find(e => e.id === executionId);

            if (!executionData) {
                $('#executionDetails').html('<h3>Execution Details</h3><p>Error: Execution data not found.</p>');
                $('#executionDetails').show();
                return;
            }

            const timestamp = new Date(executionData.timestamp).toLocaleString();
            let detailsHtml = `
                <h3>Execution Details</h3>
                <p><strong>Result:</strong> <span class="${executionData.result === 'PASS' ? 'pass' : 'fail'}">${executionData.result}</span></p>
                <p><strong>Timestamp:</strong> ${timestamp}</p>
                <p><strong>Test URL:</strong> ${executionData.url}</p>
                ${executionData.message ? `<p><strong>Message:</strong> ${executionData.message}</p>` : ''}
                <h4>Screenshots (${executionData.screenshots.length})</h4>
                <div class="screenshot-gallery">
            `;

            executionData.screenshots.forEach((screenshotUrl, i) => {
                detailsHtml += `<img src="${screenshotUrl}" alt="Screenshot" width="150" height="100" onclick="openScreenshotViewer('${executionId}', ${i})">`;
            });

            detailsHtml += `
                </div>
                <h4>Logs</h4>
                ${executionData.logsUrl ? `<p><a href="${executionData.logsUrl}" target="_blank">üìÑ Download Logs</a></p>` : '<p>No logs available</p>'}
            `;

            $('#executionDetails').html(detailsHtml);
            $('#executionDetails').show();
        }

        function toggleInputSection(btn) {
            const inputData = $(btn).siblings('.input-data');
            inputData.toggle();
        }

        function validateJson(caseId) {
            const textarea = $(`#input-${caseId}`);
            const statusEl = $(`#json-status-${caseId}`);
            try {
                const jsonText = textarea.val().trim();
                if (!jsonText) {
                    statusEl.css('color', 'orange').text('Empty input - will use default {}');
                    return;
                }
                JSON.parse(jsonText);
                statusEl.css('color', 'green').text('‚úì Valid JSON');
            } catch (e) {
                statusEl.css('color', 'red').text('‚úó Invalid JSON: ' + e.message);
            }
        }

        function closeHistoryModal() {
            $('#historyModal').hide();
            $('#executionDetails').hide();
        }

        // Screenshot Viewer variables
        let currentScreenshots = [];
        let currentScreenshotIndex = 0;

        function openScreenshotViewer(executionId, initialIndex) {
            // Fetch execution data to get screenshots
            $.get(`/executions/${executionId}`, function(execution) {
                if (execution.screenshots && execution.screenshots.length > 0) {
                    currentScreenshots = execution.screenshots;
                    currentScreenshotIndex = initialIndex;
                    updateViewerImage();
                    $('#screenshotViewerModal').show();
                }
            });
        }

        function updateViewerImage() {
            if (currentScreenshots.length > 0) {
                $('#viewerImage').attr('src', currentScreenshots[currentScreenshotIndex]);
                $('#viewerCounter').text(`${currentScreenshotIndex + 1} / ${currentScreenshots.length}`);
            }
        }

        function navigateScreenshot(direction) {
            if (currentScreenshots.length === 0) return;
            currentScreenshotIndex += direction;
            if (currentScreenshotIndex < 0) {
                currentScreenshotIndex = currentScreenshots.length - 1;
            } else if (currentScreenshotIndex >= currentScreenshots.length) {
                currentScreenshotIndex = 0;
            }
            updateViewerImage();
        }

        function closeScreenshotViewer() {
            $('#screenshotViewerModal').hide();
            currentScreenshots = [];
            currentScreenshotIndex = 0;
        }

        // Keyboard navigation for viewer
        $(document).on('keydown', function(event) {
            if ($('#screenshotViewerModal').is(':visible')) {
                switch(event.key) {
                    case 'ArrowLeft':
                        navigateScreenshot(-1);
                        break;
                    case 'ArrowRight':
                        navigateScreenshot(1);
                        break;
                    case 'Escape':
                        closeScreenshotViewer();
                        break;
                }
            }
        });

        // Close modal when clicking outside
        $(window).on('click', function(event) {
            if (event.target == $('#historyModal')[0]) {
                closeHistoryModal();
            }
            if (event.target == $('#screenshotViewerModal')[0]) {
                closeScreenshotViewer();
            }
        });

        $(document).ready(function() {
            loadSuites();
        });
    </script>
</body>
